name: CD Staging

on:
  push:
    branches: [main]

concurrency:
  group: staging-deploy
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # Build & Push Docker Images
  # ============================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      api-image: ${{ steps.meta-api.outputs.tags }}
      parser-image: ${{ steps.meta-parser.outputs.tags }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Extract metadata for Parser
        id: meta-parser
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-parser
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Parser image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/parser/Dockerfile
          push: true
          tags: ${{ steps.meta-parser.outputs.tags }}
          labels: ${{ steps.meta-parser.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push]
    environment:
      name: staging
      url: https://staging.cs2analytics.gg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Option 1: Deploy via SSH (for VPS/dedicated server)
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: ${{ secrets.STAGING_USER }}
      #     key: ${{ secrets.STAGING_SSH_KEY }}
      #     script: |
      #       cd /opt/cs2-analytics
      #       docker compose pull
      #       docker compose up -d --remove-orphans
      #       docker system prune -f

      # Option 2: Deploy to Kubernetes
      # - name: Set up kubectl
      #   uses: azure/setup-kubectl@v3
      #
      # - name: Configure kubectl
      #   run: |
      #     echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
      #     export KUBECONFIG=kubeconfig
      #
      # - name: Deploy to Kubernetes
      #   run: |
      #     kubectl set image deployment/api api=${{ needs.build-and-push.outputs.api-image }}
      #     kubectl set image deployment/parser parser=${{ needs.build-and-push.outputs.parser-image }}
      #     kubectl rollout status deployment/api
      #     kubectl rollout status deployment/parser

      - name: Deployment placeholder
        run: |
          echo "Staging deployment triggered"
          echo "API Image: ${{ needs.build-and-push.outputs.api-image }}"
          echo "Parser Image: ${{ needs.build-and-push.outputs.parser-image }}"
          echo ""
          echo "Configure deployment by uncommenting the appropriate option above:"
          echo "- SSH deployment for VPS/dedicated servers"
          echo "- Kubernetes deployment for K8s clusters"

  # ============================================
  # Smoke Tests
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Health check
        run: |
          echo "Running smoke tests against staging..."
          # Uncomment when staging URL is configured
          # curl -f https://staging-api.cs2analytics.gg/health || exit 1
          # curl -f https://staging-api.cs2analytics.gg/health/ready || exit 1
          echo "Smoke tests placeholder - configure staging URL"

      - name: Notify on success
        if: success()
        run: echo "Staging deployment successful!"

      - name: Notify on failure
        if: failure()
        run: echo "Staging deployment failed!"
